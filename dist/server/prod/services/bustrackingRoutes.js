"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var db = require("../db/pg");
var getDriverInfo = 'SELECT driver_id, driver_firstname, driver_lastname, bus_id, bus_name,bus_status, route_id, route_name FROM bus NATURAL JOIN driver NATURAL JOIN route WHERE driver_id = $1';
var getRoutes = 'SELECT route_name,route_id FROM route';
var getDriverBusID = 'SELECT bus_id FROM driver WHERE driver_id = $1';
var getGPSid = 'SELECT gps_id FROM bus WHERE bus_id = $1';
var getDriverBusGPSid = 'SELECT gps_id FROM bus NATURAL JOIN driver WHERE driver_id = $1';
var changeDriverRoute = 'UPDATE bus SET route_id = $1 where bus_id=$2';
var updateDriverBus = 'UPDATE driver SET bus_id= $1 WHERE driver_id = $2';
var updateBusStatus = 'UPDATE bus SET bus_status = $1 WHERE bus_id = $2';
var updateBusLocation = 'UPDATE GPS SET gps_latitude = $1, gps_longitude = $2 WHERE gps_id = $3';
var checkCredentials = "SELECT driver_id FROM driver WHERE driver_username=$1 and driver_password=$2";
var login = 'UPDATE driver SET driver_status = \'logged\' WHERE driver_id = $1';
var logout = 'UPDATE driver SET driver_status = \'not logged\' WHERE driver_id = $1';
var _trackURL = '/bustrackingRoutes';
function bustrack(app) {
    app.get(_trackURL + '/getDriverInfo', function (req, res, next) {
        console.log(" getting driver info", req.body);
        db.query(getDriverInfo, [req.query.driver_id], function (err, result) {
            if (err) {
                console.error(err);
                res.send("Error " + err);
            }
            else {
                res.json(result.rows[0]);
                console.log(result.rows[0]);
            }
        });
    });
    app.get(_trackURL + '/getRoutes', function (req, res, next) {
        console.log("getting tim's routes ");
        db.query(getRoutes, null, function (err, result) {
            if (err) {
                console.error(err);
                res.send("Error " + err);
            }
            else {
                res.json(result.rows);
                console.log(result.rows);
            }
        });
    });
    app.put(_trackURL + '/changeDriverRoute', function (req, res, next) {
        console.log("entre a cambiar ruta de conductor", req.body);
        db.query(changeDriverRoute, [req.body.route_id, req.body.bus_id], function (err, result) {
            if (err) {
                console.error(err);
                res.send("Error" + err);
            }
            else {
                db.query(getDriverInfo, [req.body.driver_id], function (err, result) {
                    if (err) {
                        console.error(err);
                        res.send("Error" + err);
                    }
                    else
                        res.json(result.rows[0]);
                });
            }
        });
    });
    app.put(_trackURL + '/updateBusStatus', function (req, res, next) {
        console.log("haciendo update al status del bus", req.body);
        db.query(updateBusStatus, [req.body.bus_status, req.body.bus_id], function (err, result) {
            if (err) {
                console.error(err);
                res.send("Error" + err);
            }
            else {
                db.query(getDriverInfo, [req.body.driver_id], function (err, result) {
                    if (err) {
                        console.error(err);
                        res.send("Error" + err);
                    }
                    else {
                        res.json(result.rows[0]);
                    }
                });
            }
        });
    });
    app.put(_trackURL + '/updateBusLocation', function (req, res, next) {
        console.log("updating bus location", req.body);
        db.query(getDriverBusGPSid, [req.body.driver_id], function (err, result) {
            if (err) {
                console.error(err);
                res.send("Error" + err);
            }
            else {
                var gps_id = result.rows[0].gps_id;
                db.query(updateBusLocation, [req.body.lat, req.body.lng, gps_id], function (err, result) {
                    if (err) {
                        console.error(err);
                        res.send("Error" + err);
                    }
                    else
                        res.json({ success: 1 });
                });
            }
        });
    });
    app.post(_trackURL + '/login', function (req, res, next) {
        console.log("entre al login", req.body);
        db.query(checkCredentials, [req.body.username, req.body.password], function (err, result) {
            if (err) {
                console.error(err);
                res.send("Error" + err);
            }
            else {
                if (result.rows.length == 0) {
                    res.json({ driver_id: -1 });
                }
                else {
                    var driverid = result.rows[0];
                    db.query(login, [driverid.driver_id], function (err, result) {
                        if (err) {
                            console.error(err);
                            res.send("Error" + err);
                        }
                        else {
                            console.log("driverid", driverid);
                            res.json(driverid);
                        }
                    });
                }
            }
        });
    });
    app.put(_trackURL + '/logout', function (req, res, next) {
        console.log("login out", req.body);
        db.query(logout, [req.body.driver_id], function (err, result) {
            if (err) {
                console.error(err);
                res.send("Error" + err);
            }
            else {
                res.json({ "success": 1 });
            }
        });
    });
}
exports.bustrack = bustrack;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL2J1c3RyYWNraW5nUm91dGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBaUJBLDZCQUErQjtBQUsvQixJQUFJLGFBQWEsR0FBRyw2S0FBNkssQ0FBQTtBQUNqTSxJQUFJLFNBQVMsR0FBRyx1Q0FBdUMsQ0FBQTtBQUN2RCxJQUFJLGNBQWMsR0FBRyxnREFBZ0QsQ0FBQTtBQUNyRSxJQUFJLFFBQVEsR0FBRywwQ0FBMEMsQ0FBQTtBQUV6RCxJQUFJLGlCQUFpQixHQUFHLGlFQUFpRSxDQUFBO0FBS3pGLElBQUksaUJBQWlCLEdBQUcsOENBQThDLENBQUE7QUFDdEUsSUFBSSxlQUFlLEdBQUcsbURBQW1ELENBQUE7QUFDekUsSUFBSSxlQUFlLEdBQUcsa0RBQWtELENBQUE7QUFDeEUsSUFBSSxpQkFBaUIsR0FBRyx3RUFBd0UsQ0FBQTtBQUdoRyxJQUFJLGdCQUFnQixHQUFFLDhFQUE4RSxDQUFBO0FBQ3BHLElBQUksS0FBSyxHQUFHLG1FQUFtRSxDQUFBO0FBQy9FLElBQUksTUFBTSxHQUFHLHVFQUF1RSxDQUFBO0FBRXBGLElBQUksU0FBUyxHQUFHLG9CQUFvQixDQUFBO0FBRXBDLGtCQUF5QixHQUF3QjtJQUdqRCxHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxnQkFBZ0IsRUFBRSxVQUFDLEdBQU8sRUFBRSxHQUFPLEVBQUUsSUFBUTtRQUM3RCxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixFQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUM1QyxFQUFFLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsVUFBQyxHQUFPLEVBQUUsTUFBVTtZQUUvRCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FDSixDQUFDO2dCQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFR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QUFXLEVBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzdCLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxVQUFDLEdBQU8sRUFBRSxNQUFVO1lBRXRELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUNQLENBQUM7Z0JBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsQ0FBQztZQUFDLENBQUM7WUFDakQsSUFBSSxDQUFBLENBQUM7Z0JBQ0wsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFDLFNBQVMsRUFBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDO1lBR3hCLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNYLENBQUMsQ0FBQyxDQUFDO0FBRUgsQ0FBQztBQXRLRCw0QkFzS0MiLCJmaWxlIjoic2VydmljZXMvYnVzdHJhY2tpbmdSb3V0ZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogXHJcbiAqIEF1dGhvcjogTHVpcyBUb3JvXHJcbiAqIENyZWF0aW9uIERhdGU6IDMvMjMvMjAxN1xyXG4gKlxyXG4gKiBEZXNjcmlwdGlvbjogQ29udGFpbnMgQnVzIFRyYWNraW5nIGFwcCByb3V0ZXMgYW5kIHF1ZXJpZXMgXHJcbiAqIFxyXG4gKiBSb3V0ZXM6XHJcbiAqIC91cGRhdGVSb3V0ZSBzZW5kIGJ1cyBpZCBhbmQgcm91dGUgaWRcclxuICogL2xvZ2luIHNlbmQgdXNlcm5hbWUgcGFzc3dvcmQsIHJldHVybiBkcml2ZXIgaWQgaWYgc3VjY2Vzc2Z1bCwgcmV0dXJuIC0xIGlmIHVuc3VjY2Vzc2Z1bFxyXG4gKiAvbG9nb3V0IFxyXG4gKiAvZ2V0RHJpdmVyIGluZm8gd2l0aCByb3V0ZSBhbmQgYnVzIHdpbGwgZ2V0IGJ1cyBuYW1lLCBidXMgaWQsIGRyaXZlciBuYW1lLCBkcml2ZXIgbGFzdG5hbWUsIGRyaXZlciBpZCwgcm91dGUgaWQsIHJvdXRlIG5hbWVcclxuICogL3VwZGF0ZSBzdGF0dXMgcGFyYW0gYnVzIGlkLCBidXMgc3RhdHVzXHJcbiAqIGdldFJvdXRlIHNlbmQgYmFjayBhbGwgcm91dGUgaWRzIGFuZCByb3V0ZSBuYW1lc1xyXG4qKi9cclxuXHJcblxyXG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgKiBhcyBkYiBmcm9tICcuLi9kYi9wZyc7XHJcblxyXG4vLyBRdWVyaWVzIHZhciBEZWNsYXJhdGlvbi5cclxuXHJcbi8vUm91dGVzIGZvciBnZXRcclxudmFyIGdldERyaXZlckluZm8gPSAnU0VMRUNUIGRyaXZlcl9pZCwgZHJpdmVyX2ZpcnN0bmFtZSwgZHJpdmVyX2xhc3RuYW1lLCBidXNfaWQsIGJ1c19uYW1lLGJ1c19zdGF0dXMsIHJvdXRlX2lkLCByb3V0ZV9uYW1lIEZST00gYnVzIE5BVFVSQUwgSk9JTiBkcml2ZXIgTkFUVVJBTCBKT0lOIHJvdXRlIFdIRVJFIGRyaXZlcl9pZCA9ICQxJyBcclxudmFyIGdldFJvdXRlcyA9ICdTRUxFQ1Qgcm91dGVfbmFtZSxyb3V0ZV9pZCBGUk9NIHJvdXRlJyAvL1NFTEVDVCByb3V0ZV9pZCxyb3V0ZV9uYW1lIEZST00gcm91dGVcclxudmFyIGdldERyaXZlckJ1c0lEID0gJ1NFTEVDVCBidXNfaWQgRlJPTSBkcml2ZXIgV0hFUkUgZHJpdmVyX2lkID0gJDEnXHJcbnZhciBnZXRHUFNpZCA9ICdTRUxFQ1QgZ3BzX2lkIEZST00gYnVzIFdIRVJFIGJ1c19pZCA9ICQxJ1xyXG5cclxudmFyIGdldERyaXZlckJ1c0dQU2lkID0gJ1NFTEVDVCBncHNfaWQgRlJPTSBidXMgTkFUVVJBTCBKT0lOIGRyaXZlciBXSEVSRSBkcml2ZXJfaWQgPSAkMScgXHJcblxyXG5cclxuLy9Sb3V0ZXMgZm9yIHVwZGF0ZVxyXG5cclxudmFyIGNoYW5nZURyaXZlclJvdXRlID0gJ1VQREFURSBidXMgU0VUIHJvdXRlX2lkID0gJDEgd2hlcmUgYnVzX2lkPSQyJ1xyXG52YXIgdXBkYXRlRHJpdmVyQnVzID0gJ1VQREFURSBkcml2ZXIgU0VUIGJ1c19pZD0gJDEgV0hFUkUgZHJpdmVyX2lkID0gJDInXHJcbnZhciB1cGRhdGVCdXNTdGF0dXMgPSAnVVBEQVRFIGJ1cyBTRVQgYnVzX3N0YXR1cyA9ICQxIFdIRVJFIGJ1c19pZCA9ICQyJ1xyXG52YXIgdXBkYXRlQnVzTG9jYXRpb24gPSAnVVBEQVRFIEdQUyBTRVQgZ3BzX2xhdGl0dWRlID0gJDEsIGdwc19sb25naXR1ZGUgPSAkMiBXSEVSRSBncHNfaWQgPSAkMydcclxuXHJcbi8vUm91dGVzIGZvciBsb2dpbi9sb2dvdXQgXHJcbnZhciBjaGVja0NyZWRlbnRpYWxzPSBcIlNFTEVDVCBkcml2ZXJfaWQgRlJPTSBkcml2ZXIgV0hFUkUgZHJpdmVyX3VzZXJuYW1lPSQxIGFuZCBkcml2ZXJfcGFzc3dvcmQ9JDJcIlxyXG52YXIgbG9naW4gPSAnVVBEQVRFIGRyaXZlciBTRVQgZHJpdmVyX3N0YXR1cyA9IFxcJ2xvZ2dlZFxcJyBXSEVSRSBkcml2ZXJfaWQgPSAkMSdcclxudmFyIGxvZ291dCA9ICdVUERBVEUgZHJpdmVyIFNFVCBkcml2ZXJfc3RhdHVzID0gXFwnbm90IGxvZ2dlZFxcJyBXSEVSRSBkcml2ZXJfaWQgPSAkMSdcclxuXHJcbnZhciBfdHJhY2tVUkwgPSAnL2J1c3RyYWNraW5nUm91dGVzJ1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGJ1c3RyYWNrKGFwcDogZXhwcmVzcy5BcHBsaWNhdGlvbikge1xyXG5cclxuLy9nZXQgaW5mb3JtYXRpb24gZnJvbSBkcml2ZXIgZnJvbSBkYXRhYmFzZSBhbmQgc2VuZCBiYWNrIHRvIGFwcGxpY2F0aW9uXHJcbmFwcC5nZXQoX3RyYWNrVVJMICsgJy9nZXREcml2ZXJJbmZvJywgKHJlcTphbnksIHJlczphbnksIG5leHQ6YW55KSA9PiB7IC8vIFBhcmFtZXRlcjogUm91dGUgSURcclxuICAgIGNvbnNvbGUubG9nKFwiIGdldHRpbmcgZHJpdmVyIGluZm9cIixyZXEuYm9keSlcclxuICAgIGRiLnF1ZXJ5KGdldERyaXZlckluZm8sIFtyZXEucXVlcnkuZHJpdmVyX2lkXSwgKGVycjphbnksIHJlc3VsdDphbnkpID0+IHtcclxuXHJcbiAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgeyBjb25zb2xlLmVycm9yKGVycik7IHJlcy5zZW5kKFwiRXJyb3IgXCIgKyBlcnIpOyB9XHJcbiAgICAgICAgZWxzZXtcclxuICAgICAgICByZXMuanNvbihyZXN1bHQucm93c1swXSk7XHJcbiAgICAgICAgY29uc29sZS5sb2cocmVzdWx0LnJvd3NbMF0pXHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn0pO1xyXG5cclxuLy9nZXQgcm91dGVzIG5hbWVzIGFuZCBpZHMgZnJvbSBkYXRhYmFzZSBhbmQgc2VuZCBiYWNrIHRvIGFwcGxpY2F0aW9uXHJcbmFwcC5nZXQoX3RyYWNrVVJMICsgJy9nZXRSb3V0ZXMnLCAocmVxOmFueSwgcmVzOmFueSwgbmV4dDphbnkpID0+IHsgLy8gUGFyYW1ldGVyOiBSb3V0ZSBJRFxyXG4gICAgY29uc29sZS5sb2coXCJnZXR0aW5nIHRpbSdzIHJvdXRlcyBcIilcclxuICAgICAgICBkYi5xdWVyeShnZXRSb3V0ZXMsIG51bGwsIChlcnI6YW55LCByZXN1bHQ6YW55KSA9PiB7XHJcblxyXG4gICAgICAgICAgICBpZiAoZXJyKXtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTsgcmVzLnNlbmQoXCJFcnJvciBcIiArIGVycik7IH1cclxuICAgICAgICAgICAgZWxzZXtcclxuICAgICAgICAgICAgICAgIHJlcy5qc29uKHJlc3VsdC5yb3dzKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdC5yb3dzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG59KTtcclxuXHJcblxyXG4vL2NoYW5nZSBkcml2ZXIgcm91dGUsIHVwZGF0aW5nIG9uIGRhdGFiYXNlIGFuZCBzZW5kaW5nIGJhY2sgZHJpdmVyIGluZm8gdG8gYXBwbGljYXRpb25cclxuYXBwLnB1dChfdHJhY2tVUkwgKyAnL2NoYW5nZURyaXZlclJvdXRlJywgKHJlcTphbnksIHJlczphbnksIG5leHQ6YW55KSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZyhcImVudHJlIGEgY2FtYmlhciBydXRhIGRlIGNvbmR1Y3RvclwiLHJlcS5ib2R5KVxyXG4gICAgICAgIGRiLnF1ZXJ5KGNoYW5nZURyaXZlclJvdXRlLFtyZXEuYm9keS5yb3V0ZV9pZCxyZXEuYm9keS5idXNfaWRdICwoZXJyOmFueSwgcmVzdWx0OmFueSkgPT4ge1xyXG5cclxuICAgICAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7IHJlcy5zZW5kKFwiRXJyb3JcIiArIGVycik7XHJcbiAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBlbHNle1xyXG4gICAgICAgICAgICAgICAgZGIucXVlcnkoZ2V0RHJpdmVySW5mbyxbcmVxLmJvZHkuZHJpdmVyX2lkXSAsKGVycjphbnksIHJlc3VsdDphbnkpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgICAgICAgeyBcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7IHJlcy5zZW5kKFwiRXJyb3JcIiArIGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICByZXMuanNvbihyZXN1bHQucm93c1swXSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbn0pO1xyXG5cclxuLy91cGRhdGluZyBidXMgc3RhdHVzIG9uIGRhdGFiYXNlIGFuZCB0aGVuIHNlbmRpbmcgYmFjayBkcml2ZXIgaW5mbyB0byBhcHBsaWNhdGlvblxyXG5hcHAucHV0KF90cmFja1VSTCArICcvdXBkYXRlQnVzU3RhdHVzJywgKHJlcTphbnksIHJlczphbnksIG5leHQ6YW55KSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZyhcImhhY2llbmRvIHVwZGF0ZSBhbCBzdGF0dXMgZGVsIGJ1c1wiLCByZXEuYm9keSlcclxuICAgICAgICBkYi5xdWVyeSh1cGRhdGVCdXNTdGF0dXMsW3JlcS5ib2R5LmJ1c19zdGF0dXMscmVxLmJvZHkuYnVzX2lkXSAsKGVycjphbnksIHJlc3VsdDphbnkpID0+IHtcclxuXHJcbiAgICAgICAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgICAgICB7IFxyXG4gICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTsgcmVzLnNlbmQoXCJFcnJvclwiICsgZXJyKTsgXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZXtcclxuICAgICAgICAgICAgICAgIGRiLnF1ZXJ5KGdldERyaXZlckluZm8sW3JlcS5ib2R5LmRyaXZlcl9pZF0gLChlcnI6YW55LCByZXN1bHQ6YW55KSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgICAgIHsgXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpOyByZXMuc2VuZChcIkVycm9yXCIgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZXtcclxuICAgICAgICAgICAgICAgIHJlcy5qc29uKHJlc3VsdC5yb3dzWzBdKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxufSk7XHJcblxyXG5cclxuLypcclxudXBkYXRlQnVzTG9jYXRpb24gc2VydmVyIHJvdXRlIHVzZSBydW4gdHdvIHF1ZXJ0aWVzOlxyXG4gICAgZ2V0RHJpdmVyQnVzR1BTaWQgXHJcbiAgICAgICAgUGFyYW1ldGVyOiBkcml2ZXJfaWRcclxuICAgICAgICBHZXQ6IEdQUyBJRCBvZiB0aGUgY29ycmVzcG9uZGluZyBkcml2ZXIgYnVzXHJcblxyXG4gICAgdXBkYXRlQnVzTG9jYXRpb25cclxuICAgICAgICBQYXJhbWV0ZXI6IGdwc19sYXRpdHVkZSwgZ3BzX2xvbmdpdHVkZSwgZ3BzX2lkXHJcbiAgICAgICAgVXBkYXRlOiBBY3R1YWwgbG9jYXRpb24gb2YgdGhlIGJ1cyAgdXNpZ24gZ3BzX2xhdGl0dWRlIGFuZCBncHNfbG9uZ2l0dWRlIHBhcmFtZXRlcnMgXHJcbiovXHJcbmFwcC5wdXQoX3RyYWNrVVJMICsgJy91cGRhdGVCdXNMb2NhdGlvbicsIChyZXE6YW55LCByZXM6YW55LCBuZXh0OmFueSkgPT4geyBcclxuICAgIFxyXG4gICAgY29uc29sZS5sb2coXCJ1cGRhdGluZyBidXMgbG9jYXRpb25cIixyZXEuYm9keSlcclxuICAgICBcclxuICAgICAgICBkYi5xdWVyeShnZXREcml2ZXJCdXNHUFNpZCxbcmVxLmJvZHkuZHJpdmVyX2lkXSAsKGVycjphbnksIHJlc3VsdDphbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgIHsgY29uc29sZS5lcnJvcihlcnIpOyByZXMuc2VuZChcIkVycm9yXCIgKyBlcnIpOyB9XHJcbiAgICAgICAgICAgIGVsc2V7XHJcbiAgICAgICAgICAgIHZhciBncHNfaWQgPSByZXN1bHQucm93c1swXS5ncHNfaWRcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgZGIucXVlcnkodXBkYXRlQnVzTG9jYXRpb24sW3JlcS5ib2R5LmxhdCxyZXEuYm9keS5sbmcsZ3BzX2lkXSAsKGVycjphbnksIHJlc3VsdDphbnkpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgICAgICAgICB7IGNvbnNvbGUuZXJyb3IoZXJyKTsgcmVzLnNlbmQoXCJFcnJvclwiICsgZXJyKTsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICByZXMuanNvbih7c3VjY2VzczoxfSlcclxuICAgICAgICAgICAgICAgICAgICBcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvL1VwZGF0ZSB0aGUgbG9jYWxpemF0aW9uIG9mIHRoZSBEcml2ZXIgQnVzIHVzaW5nIHRoZSBidXMgR1BTIElEXHJcbiAgICAgICAgICAgXHJcbiAgICAgICAgfSk7XHJcbn0pO1xyXG5cclxuXHJcblxyXG4vL1JvdXRlcyBmb3IgbG9naW4vbG9nb3V0XHJcbi8vbG9naW4gZHJpdmVyIG9uIHN5c3RlbSwgdXBkYXRpbiBkcml2ZXIgc3RhdHVzIHRvIFwibG9nZ2VkIGluXCIgaWYgY3JlZGVudGlhbHMgYXJlIGNvcnJlY3RcclxuLy9pZiBjcmVkZW50aWFscyBhcmUgaW5jb3JyZWN0IHNlbmQgLTEgYmFjayBhcyBhIHJlc3BvbnNlXHJcbmFwcC5wb3N0KF90cmFja1VSTCArICcvbG9naW4nLCAocmVxOmFueSwgcmVzOmFueSwgbmV4dDphbnkpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKFwiZW50cmUgYWwgbG9naW5cIixyZXEuYm9keSlcclxuICAgIFxyXG4gICAgICAgIGRiLnF1ZXJ5KGNoZWNrQ3JlZGVudGlhbHMsW3JlcS5ib2R5LnVzZXJuYW1lLCByZXEuYm9keS5wYXNzd29yZF0gLChlcnI6YW55LCByZXN1bHQ6YW55KSA9PiB7XHJcblxyXG4gICAgICAgICAgICBpZiAoZXJyKXsgXHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7IHJlcy5zZW5kKFwiRXJyb3JcIiArIGVycik7IFxyXG4gICAgICAgICAgICB9ZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZihyZXN1bHQucm93cy5sZW5ndGg9PTApe1xyXG4gICAgICAgICAgICAgICAgIHJlcy5qc29uKHtkcml2ZXJfaWQ6LTF9KTtcclxuICAgICAgICAgICAgICAgIH1lbHNlIHtcclxuICAgICAgICAgICAgICAgIHZhciBkcml2ZXJpZD1yZXN1bHQucm93c1swXTsgICAgXHJcbiAgICAgICAgICAgICAgICBkYi5xdWVyeShsb2dpbixbZHJpdmVyaWQuZHJpdmVyX2lkXSAsKGVycjphbnksIHJlc3VsdDphbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKXsgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTsgcmVzLnNlbmQoXCJFcnJvclwiICsgZXJyKTsgXHJcbiAgICAgICAgICAgICAgICAgICAgfWVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImRyaXZlcmlkXCIsZHJpdmVyaWQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5qc29uKGRyaXZlcmlkKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgIH0pO1xyXG59KTtcclxuXHJcbi8vbG9naW5nIG91dCBkcml2ZXIsIHVwZHRpbmcgZHJpdmVyIHN0YXR1cyBvbiBkYXRhYmFzZVxyXG5hcHAucHV0KF90cmFja1VSTCArICcvbG9nb3V0JywgKHJlcTphbnksIHJlczphbnksIG5leHQ6YW55KSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZyhcImxvZ2luIG91dFwiLHJlcS5ib2R5KVxyXG4gICAgICAgIGRiLnF1ZXJ5KGxvZ291dCxbcmVxLmJvZHkuZHJpdmVyX2lkXSAsKGVycjphbnksIHJlc3VsdDphbnkpID0+IHtcclxuXHJcbiAgICAgICAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgICAgICB7IGNvbnNvbGUuZXJyb3IoZXJyKTsgcmVzLnNlbmQoXCJFcnJvclwiICsgZXJyKTsgfVxyXG4gICAgICAgICAgICBlbHNle1xyXG4gICAgICAgICAgICByZXMuanNvbih7XCJzdWNjZXNzXCI6MX0pO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxufSk7XHJcblxyXG59XHJcblxyXG4iXX0=
